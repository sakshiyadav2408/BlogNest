<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Profile - Blog Nest</title>
  <link rel="stylesheet" href="profile.css" />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="navbar">
    <div class="logo">ü™Ñ Blog Nest</div>
    <nav class="nav-links">
      <a href="author-profile.html" class="btn">üë§Profile</a>
      <a href="index.html" class="btn logout">Logout</a>
    </nav>
  </header>

  <main class="profile-container">
    <section class="user-summary">
      <h2 id="welcomeUser">Welcome, Developer!</h2>
      <p>You are logged in. Here you can manage your blogs, create new posts, and explore recent developer stories.</p>
    </section>

    <section class="search-create">
      <input type="text" id="searchInput" placeholder="üîç Search your posts by tag‚Ä¶" class="search-box"/>
      <button id="searchBtn" class="btn create">üîç Search</button>
    </section>

    <section class="recent-posts">
      <h3>üïí Recent Posts</h3>
      <div id="postList"></div>
    </section>
  </main>

  <script>
    let allPosts = [];

    document.addEventListener("DOMContentLoaded", async () => {
      const token = localStorage.getItem("jwt");
      if (!token) return alert("You are not logged in!");

      try {
        const res = await fetch("http://localhost:5000/api/posts", {
          headers: { Authorization: `Bearer ${token}` },
        });

        const posts = await res.json();
        if (!res.ok) return alert(posts.error || "Failed to load posts");

        allPosts = posts;
        displayPosts(allPosts);
      } catch (err) {
        console.error("Error loading posts:", err);
      }

      // Search click listener
      document.getElementById("searchBtn").addEventListener("click", () => {
        const query = document.getElementById("searchInput").value.trim().toLowerCase();
        if (!query) {
          displayPosts(allPosts);
          return;
        }

        const filtered = allPosts.filter(post =>
          Array.isArray(post.tags) &&
          post.tags.some(tag => tag.toLowerCase().includes(query))
        );
        displayPosts(filtered);
      });

      document.getElementById("searchInput").addEventListener("keyup", e => {
        if (e.key === "Enter") document.getElementById("searchBtn").click();
      });
    });

    function displayPosts(posts) {
      const container = document.getElementById("postList");
      container.innerHTML = "";

      if (posts.length === 0) {
        container.innerHTML = "<p>No posts found for this tag.</p>";
        return;
      }

      posts.forEach(post => {
        const postEl = document.createElement("div");
        postEl.classList.add("post-card");

        postEl.innerHTML = `
          <h2>${post.title}</h2>
          <p><strong>Author:</strong> ${post.authorName}</p>
          <p><strong>Tags:</strong> ${(post.tags || []).join(", ")}</p>
          <div>${post.html}</div>

          <div class="comment-section">
            <h5>üó®Ô∏è Comments</h5>
            <div class="comments" id="comments-${post._id}">Loading comments‚Ä¶</div>

            <textarea class="comment-input" id="input-${post._id}" placeholder="Add a comment..."></textarea>
            <button class="btn comment-btn" onclick="addComment('${post._id}')">Post Comment</button>
          </div>
          <hr />
        `;

        container.appendChild(postEl);
        loadComments(post._id);
      });
    }

    async function loadComments(postId) {
      const commentBox = document.getElementById(`comments-${postId}`);
      try {
        const res = await fetch(`http://localhost:5000/api/posts/${postId}/comments`);
        const comments = await res.json();
        if (!res.ok) throw comments;

        if (!comments.length) {
          commentBox.innerHTML = "<p></p>";
        } else {
          commentBox.innerHTML = comments.map(c => `
            <div class="comment">
              <p><strong>${c.authorName}</strong>: ${c.text}</p>
            </div>
          `).join("");
        }
      } catch (err) {
        commentBox.innerHTML = "<p class='error'>Failed to load comments.</p>";
      }
    }

    async function addComment(postId) {
      const token = localStorage.getItem("jwt");
      if (!token) return alert("Please login to comment.");

      const input = document.getElementById(`input-${postId}`);
      const text = input.value.trim();
      if (!text) return alert("Comment cannot be empty.");

      try {
        const res = await fetch(`http://localhost:5000/api/posts/${postId}/comments`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ text })
        });

        const result = await res.json();
        if (!res.ok) throw result;

        input.value = "";
        loadComments(postId);
      } catch (err) {
        alert(err.error || "Failed to post comment.");
      }
    }
  </script>
</body>
</html>